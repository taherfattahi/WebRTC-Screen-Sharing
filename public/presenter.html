<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Presenter</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='stylesheet' type='text/css' media='screen' href='assets/style/presenter.css'>
</head>

<body>
    <div id="divStatus" class="dsh-status">
        <span>
            <label>Presenter ID</label>
            <span id="lblPresenterId">waiting</span>
        </span> 
        <span>
            <label>Online viewers</label>
            <span id="lblOnlineViewers">waiting</span>
        </span>
        <span>
            <label>Sharing status</label>
            <span id="lblSharingStatus">waiting</span>
        </span>
    </div>
    <div id="divToolbar" class="dsh-toolbar">
        <span>
            <label>Mechanism</label>
            <span>
                <select id="cmbMechanism">
                    <option value="peer">Peer-2-Peer</option>
                    <!-- <option value="distributed">Distributed boradcast</option> -->
                    <!-- <option value="streamserver">Streaming server</option> -->
                </select>
            </span>
        </span>
        <span>
            <label>Max frame rate</label>
            <span>
                <select id="cmbMaxFrameRate">
                    <option value="5" selected>5 fps</option>
                    <option value="10">10 fps</option>
                    <option value="15">15 fps</option>
                    <option value="20">20 fps</option>
                    <option value="25">25 fps</option>
                    <option value="30">30 fps</option>
                </select>
            </span>
        </span>
        <span>
            <label>Max screen size</label>
            <span>
                <select id="cmbScreenSize">
                    <option value="640*360">nHD 640 x 360</option>
                    <option value="800*600">SVGA 800 x 600</option>
                    <option value="1024*768">XGA 1024 x 768</option>
                    <option value="1360*768" selected>HD 1360 x 768</option>
                    <option value="1600*900">HD+ 1600 x 900</option>
                    <option value="1920*1080">FHD 1920 x 1080</option>
                    <option value="2560*1440">QHD 2560 x 1440</option>
                    <option value="3840*2160">4K UHD 3840 x 2160</option>
                </select>
            </span>
        </span>
        <span>
            <label>Microphone</label>
            <span>
                <select id="cmbMicrophone">
                    <option value="muted" selected>Muted</option>
                    <option value="unmuted">Unmuted</option>
                </select>
            </span>
        </span>
        <button id="bthSharing" value="stop">Start Sharing</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.3/socket.io.js"
    integrity="sha512-2RDFHqfLZW8IhPRvQYmK9bTLfj/hddxGXQAred2wNZGkrKQkLGj8RCkXfRJPHlDerdHHIzTFaahq4s/P4V6Qig=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/sweetalert2@11.3.5"></script>


    <script type="module">

		function makeid(length) {
			var result           = '';
			var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
			var charactersLength = characters.length;
			for ( var i = 0; i < length; i++ ) {
			  result += characters.charAt(Math.floor(Math.random() * 
		 charactersLength));
		   }
		   return result;
		}
		history.pushState(null, null, 'presenter.html?sessionid=' + makeid(7));

        let  swalBackground = 'radial-gradient(#666, #333)';
        const welcomeImg = './assets/image/3DTesterEn.png';
        let personalID = "";

        Swal.fire({
            allowOutsideClick: false,
            allowEscapeKey: false,
            background: swalBackground,
            position: 'center',
            imageAlt: 'mirotalk-name',
            imageUrl: welcomeImg,
            title: '<div style="color:white;">Enter your personal ID</div>',
            input: 'text',
            confirmButtonText: `Confirm`,
            showClass: {
                popup: 'animate__animated animate__fadeInDown',
            },
            hideClass: {
                popup: 'animate__animated animate__fadeOutUp',
            },
            inputValidator: (value) => {
                if (!value) return 'Please enter your personal ID';
                personalID = value;
				document.getElementById("lblPresenterId").innerHTML = personalID;
                presenterObj.setPersonalId(personalID);
            },
        }).then(() => {
        });

        document.getElementsByClassName("swal2-input")[0].style.color = "white";
        document.getElementsByClassName("swal2-image")[0].style.width="300px";
        document.getElementsByClassName("swal2-image")[0].style.height="200px";

        import presenter from './assets/js/presenter.js';
        var presenterObj = new presenter({
            iceServers: [
			 /*{
            urls: 'stun:openrelay.metered.ca:80',
        },
        {
            urls: 'turn:openrelay.metered.ca:80',
            username: 'openrelayproject',
            credential: 'openrelayproject',
        },
        {
            urls: 'turn:openrelay.metered.ca:443',
            username: 'openrelayproject',
            credential: 'openrelayproject',
        },
        {
            urls: 'turn:openrelay.metered.ca:443?transport=tcp',
            username: 'openrelayproject',
            credential: 'openrelayproject',
        },*/
                 { urls: 'stun:136.243.172.245:3478?transport=udp' },
				{ urls: 'turn:136.243.172.245:3478?transport=udp',
                    username: 'test',
					credential: 'test123', },
				{ urls: 'turn:136.243.172.245:3478?transport=tcp',
					username: 'test',
					credential: 'test123', },
            ],
            mechanism: document.getElementById("cmbMechanism").value,
        });


        presenterObj.onStatusChanged = function () {
            if (!this.validPresenter) {
                let divInvalidPresenter = document.createElement("div");
                divInvalidPresenter.id = "divInvalidPresenter";
                divInvalidPresenter.className = "dsh-invalid-presenter";
                divInvalidPresenter.innerText = "Another presenter in running.";
                document.body.append(divInvalidPresenter);

            }
            if (this.isConnected) {
                document.getElementById("divConnectionStatus") && document.getElementById("divConnectionStatus").remove();
            }
            else {
                let divConnectionStatus = document.createElement("div");
                divConnectionStatus.id = "divConnectionStatus";
                divConnectionStatus.className = "dsh-disconnected";
                divConnectionStatus.innerText = "Connection to server is lost";
                document.body.append(divConnectionStatus);
            }
            // document.getElementById('lblPresenterId').innerText = this.socket ? this.socket.id : '-';
            document.getElementById('lblOnlineViewers').innerText = Object.keys(this.viewers).length;
            document.getElementById('lblSharingStatus').innerText = this.sharingStream.display ? 'shared' : 'not shared';
            if (this.sharingStream.display) {
                document.getElementById('divStatus').classList.add('dsh-active');
                document.getElementById('cmbMechanism').disabled = true;
                document.getElementById('cmbMaxFrameRate').disabled = true;
                document.getElementById('cmbScreenSize').disabled = true;
            }
            else {
                document.getElementById('divStatus').classList.remove('dsh-active');
                document.getElementById('cmbMechanism').disabled = false;
                document.getElementById('cmbMaxFrameRate').disabled = false;
                document.getElementById('cmbScreenSize').disabled = false;
            }
        };

        document.getElementById('cmbMechanism').addEventListener("change", async (e) => {
            presenterObj.setMechanism(e.target.value);
        });

        document.getElementById('bthSharing').addEventListener("click", async (e) => {
            let btn = e.target;
            if (btn.value == "stop") {
                btn.innerText = "Initializing"
                btn.disabled = true;
                btn.value = "initializing";
                presenterObj.startSharing({
                    mechanism: document.getElementById("cmbMechanism").value,
                    maxFrameRate: document.getElementById("cmbMaxFrameRate").value,
                    screenSize: document.getElementById("cmbScreenSize").value,
                    microphone: document.getElementById("cmbMicrophone").value
                },
                    () => {
                        btn.innerText = "Stop Sharing";
                        btn.value = "start";
                        btn.disabled = false;
                        presenterObj.onStatusChanged();
                    },
                    () => {
                        btn.innerText = "Start Sharing";
                        btn.value = "stop";
                        btn.disabled = false;
                        presenterObj.onStatusChanged();
                    },
                    () => {
                        btn.innerText = "Start Sharing";
                        btn.value = "stop";
                        btn.disabled = false;
                        presenterObj.onStatusChanged();
                    }
                );
            }
            else if (btn.value == "start") {
                presenterObj.stopSharing(() => {
                    btn.innerText = "Start Sharing";
                    btn.value = "stop";
                    btn.disabled = false;
                    presenterObj.onStatusChanged();
                });
            }
        });

        document.getElementById('cmbMicrophone').addEventListener('change', (e) => {
            presenterObj.setOptions({
                microphone: e.target.value
            });
        });

        window.startPresent = (options, startEvent, stopEvent, failedEvent) => {
            presenterObj.startSharing(options, startEvent, stopEvent, failedEvent);
        }

        window.stopPresent = (stopEvent) => {
            presenterObj.stopSharing(stopEvent);
        }
    </script>
</body>